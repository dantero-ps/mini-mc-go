---
phase: 01-3d-terrain-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/world/generator_test.go
  - internal/world/noise_test.go
  - internal/world/density.go
autonomous: false

must_haves:
  truths:
    - "Generation remains deterministic from same seed"
    - "Performance maintains 60 FPS during chunk generation"
    - "Terrain includes natural overhangs and floating formations"
    - "Underground empty spaces exist (pre-cave system)"
  artifacts:
    - path: "internal/world/generator_test.go"
      provides: "Determinism, correctness, and feature tests for DensityGenerator"
      contains: "TestDensityDeterminism"
    - path: "internal/world/noise_test.go"
      provides: "3D noise function unit tests"
      contains: "TestValueNoise3D"
  key_links:
    - from: "internal/world/generator_test.go"
      to: "internal/world/density.go"
      via: "NewDensityGenerator in test setup"
      pattern: "NewDensityGenerator"
    - from: "internal/world/noise_test.go"
      to: "internal/world/noise.go"
      via: "valueNoise3D and octaveNoise3D calls"
      pattern: "valueNoise3D|octaveNoise3D"
---

<objective>
Verify the 3D density terrain system through comprehensive tests and visual inspection.

Purpose: Ensure the density generator is deterministic (same seed = identical world), produces terrain with overhangs and underground voids, performs within 60 FPS budget, and looks good visually. This is the quality gate before marking Phase 1 complete.

Output: Test suite proving determinism and correctness. Visual confirmation of terrain quality. Performance baseline established.
</objective>

<execution_context>
@/Users/furkandogan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/furkandogan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-3d-terrain-foundation/01-RESEARCH.md
@.planning/phases/01-3d-terrain-foundation/01-01-SUMMARY.md

# Source files
@internal/world/noise.go
@internal/world/density.go
@internal/world/generator.go
@internal/world/generator_test.go
@internal/world/chunk.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3D noise and density generator tests</name>
  <files>internal/world/noise_test.go, internal/world/generator_test.go</files>
  <action>
**Create `internal/world/noise_test.go`** with the following tests:

1. `TestHash3Deterministic` — Call `hash3(10, 20, 30, 42)` 100 times, verify all results identical.

2. `TestHash3DifferentInputs` — Verify that hash3 produces different values for:
   - Different X: hash3(1,0,0,seed) != hash3(2,0,0,seed)
   - Different Y: hash3(0,1,0,seed) != hash3(0,2,0,seed)
   - Different Z: hash3(0,0,1,seed) != hash3(0,0,2,seed)
   - Different seed: hash3(1,1,1,seed1) != hash3(1,1,1,seed2)
   - Axis swap: hash3(1,2,3,seed) != hash3(3,2,1,seed) — ensures axes aren't interchangeable

3. `TestValueNoise3DRange` — Sample valueNoise3D at 1000 random points (use deterministic seed for test RNG), verify all values in [0,1].

4. `TestValueNoise3DDeterministic` — Call valueNoise3D(1.5, 2.7, 3.3, 42) 100 times, verify all results identical (exact float64 match).

5. `TestValueNoise3DContinuity` — Sample at two nearby points (e.g., (1.0, 1.0, 1.0) and (1.01, 1.0, 1.0)). Verify the difference is small (< 0.1). This confirms smooth interpolation rather than random noise.

6. `TestOctaveNoise3DRange` — Sample octaveNoise3D at 1000 points with 4 octaves, verify all in [0,1].

7. `TestOctaveNoise3DDeterministic` — Same point, 100 calls, all identical.

**Extend `internal/world/generator_test.go`** with the following tests (append, do NOT modify existing tests):

8. `TestDensityGeneratorImplementsInterface` — `var _ TerrainGenerator = NewDensityGenerator(123)` (compile-time check).

9. `TestDensityDeterminism` — Generate the same chunk (0,0,0) with seed 12345 using NewDensityGenerator 100 times. Serialize each chunk's block data and SHA-256 hash it. All 100 hashes must be identical. Use `crypto/sha256` and `encoding/binary`.
   - Serialize by iterating all positions (ly 0..ChunkSizeY-1, lx 0..ChunkSizeX-1, lz 0..ChunkSizeZ-1) and writing GetBlock(lx,ly,lz) as uint8.

10. `TestDensityDeterminismMultipleChunks` — Generate chunks at (0,0,0), (1,0,0), (0,0,1), (-1,0,-1) twice each. Verify each pair produces identical block data. This tests that world coordinates are used correctly (not local).

11. `TestDensityTerrainNotEmpty` — Generate chunk at (0,0,0) with seed 1337. Count non-air blocks. Verify count > 0 (terrain exists, not all air).

12. `TestDensityTerrainNotSolid` — Generate chunk at (0,0,0) with seed 1337. Count air blocks. Verify count > 0 (has air, not all solid).

13. `TestDensityBedrockAtZero` — Generate chunk at (0,0,0). Verify GetBlock(8, 0, 8) == BlockTypeBedrock (y=0 should always be bedrock due to high density at bottom).

14. `TestDensityHighAltitudeAir` — Generate chunk at (0,1,0) (chunk Y=1, so blocks at worldY 256-511). All blocks should be air since this is far above baseHeight=64. Verify all blocks are BlockTypeAir by iterating entire chunk.

15. `TestDensityHeightAt` — Call HeightAt on DensityGenerator. Verify it returns a reasonable value (> 0 and <= baseHeight + gradientStrength, i.e., roughly 64+32=96). This tests the chunk streaming integration point.

16. `BenchmarkDensityPopulateChunk` — Benchmark PopulateChunk for a single chunk. Use `testing.B` and `b.ResetTimer()`. Report ns/op. Target: < 50ms per chunk (but don't fail on this — just report).

For the hash function in determinism test, use this pattern:
```go
func hashChunkBlocks(c *Chunk) [32]byte {
    h := sha256.New()
    for ly := 0; ly < ChunkSizeY; ly++ {
        for lx := 0; lx < ChunkSizeX; lx++ {
            for lz := 0; lz < ChunkSizeZ; lz++ {
                b := byte(c.GetBlock(lx, ly, lz))
                h.Write([]byte{b})
            }
        }
    }
    var result [32]byte
    copy(result[:], h.Sum(nil))
    return result
}
```

IMPORTANT: Import "crypto/sha256" and "math/rand" (for test RNG with fixed seed, NOT for game logic). Keep all existing tests unchanged.
  </action>
  <verify>
Run `go build ./internal/world/` first to catch any compilation errors in new test files. Then run `go test ./internal/world/... -v -count=1` and verify all tests pass. Run `go test ./internal/world/... -bench=BenchmarkDensity -benchmem` to get performance baseline. All determinism tests must pass with 0 failures.
  </verify>
  <done>noise_test.go exists with 7 tests covering hash3, valueNoise3D, octaveNoise3D. generator_test.go extended with 9 new tests covering DensityGenerator determinism, correctness, edge cases, and benchmark. All tests pass. Benchmark shows chunk generation time.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete 3D density-based terrain system replacing the 2D heightmap. Terrain now generates using a 3D noise function combined with a height gradient, producing overhangs, underground voids, and varied vertical features. All determinism and correctness tests pass.
  </what-built>
  <how-to-verify>
1. Run the game: `cd /Users/furkandogan/Documents/Projects/gogl && go run ./cmd/mini-mc/`
2. Look at the terrain — it should be stone (no grass/dirt, by design for Phase 1)
3. **Check for overhangs:** Walk around until you find terrain hanging over empty space below it. May need to explore for 30-60 seconds. Look for cliff faces with protruding ledges.
4. **Check for underground voids:** Dig down or fly (if creative mode available) to find empty spaces inside the terrain. These are pre-cave system voids.
5. **Check for varied terrain:** Terrain should not be flat — hills, valleys, and varied elevation should be visible.
6. **Check chunk boundaries:** Walk across chunk borders (every 16 blocks). There should be NO visible seams or misaligned blocks at boundaries.
7. **Check performance:** The game should run at 60+ FPS during normal gameplay and chunk generation. Check if there's any noticeable stutter when new chunks load.
8. **Check determinism:** Quit and restart the game. The terrain at spawn should look identical to the previous run.

If terrain is all stone with no variety, or all air, or has visible seams — report the issue.
If overhangs are too subtle or non-existent, the noise parameters may need tuning — describe what you see.
  </how-to-verify>
  <resume-signal>Type "approved" if terrain looks good, or describe issues (e.g., "too flat", "no overhangs visible", "chunk seams at x=16", "performance issues")</resume-signal>
</task>

</tasks>

<verification>
1. `go test ./internal/world/... -v -count=1` — all tests pass
2. `go test ./internal/world/... -bench=BenchmarkDensity` — reports chunk gen time
3. Visual inspection confirms:
   - Terrain has overhangs/ledges
   - Underground voids exist
   - No chunk boundary seams
   - 60+ FPS maintained
   - Same seed produces same terrain
</verification>

<success_criteria>
- All 16+ tests pass (7 noise + 9 generator) including determinism verification
- Benchmark shows chunk generation under 50ms (target, not hard requirement)
- Visual confirmation: terrain has overhangs, underground voids, varied elevation
- No chunk boundary seams visible
- Game maintains 60 FPS during chunk generation
- Same seed produces identical terrain across restarts
</success_criteria>

<output>
After completion, create `.planning/phases/01-3d-terrain-foundation/01-02-SUMMARY.md`
</output>
